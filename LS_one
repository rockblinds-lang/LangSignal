import ctypes
import time
import threading
import winsound
import pystray
import os
import sys
from PIL import Image, ImageDraw
class LanguageHandler:
    def __init__(self):
        self.last_lang = self.get_current_lang()
        self.debounce_timer = None
        self.delay = 0.25 

    def get_current_lang(self):
        try:
            user32 = ctypes.windll.user32
            hwnd = user32.GetForegroundWindow()
            if not hwnd: return None
            thread_id = user32.GetWindowThreadProcessId(hwnd, 0)
            layout = user32.GetKeyboardLayout(thread_id) & 0xFFFF
            return layout
        except:
            return None

    def on_layout_change(self, new_lang):
        if new_lang is None or new_lang == self.last_lang:
            return
        if self.debounce_timer:
            self.debounce_timer.cancel()
        self.debounce_timer = threading.Timer(self.delay, self.confirm_change, [new_lang])
        self.debounce_timer.start()

    def confirm_change(self, confirmed_lang):
        current_now = self.get_current_lang()
        if confirmed_lang == current_now and confirmed_lang != self.last_lang:
            print(f"Зміна розкладки на: {confirmed_lang}")
            self.last_lang = confirmed_lang
            self.play_sound(confirmed_lang)

 def play_sound(self, lang):
        try:
            if lang == 1033:  # EN (нижчий тон)
                winsound.Beep(750, 150) 
            elif lang == 1058:  # UA (вищий тон)
                winsound.Beep(1000, 150)
        except:
            pass

def create_image(text="LS"):
    # Створюємо іконку 64x64
    # Синій фон для UA, темно-сірий для EN, чорний для інших
    color = (0, 120, 215) if text == "UA" else (60, 60, 60) if text == "EN" else (0, 0, 0)
    image = Image.new('RGB', (64, 64), color=color)
    dc = ImageDraw.Draw(image)
    
    # Малюємо текст (використовуємо стандартний шрифт PIL)
    # Якщо захочете гарний шрифт, пізніше підключимо .ttf файл
    dc.text((18, 25), text, fill="white") 
    return image

def monitor_loop(handler, icon):
    print("LangSignal: Моніторинг активний...")
    while True:
        lang = handler.get_current_lang()
        if lang:
            # Визначаємо текст для іконки
            text = "EN" if lang == 1033 else "UA" if lang == 1058 else "??"

    monitor_thread = threading.Thread(target=monitor_loop, args=(handler,), daemon=True)
    monitor_thread.start()

    # Створюємо меню
    menu = pystray.Menu(
        pystray.MenuItem('Автозапуск', lambda: setup_autostart(True)),
        pystray.MenuItem('Вимкнути автозапуск', lambda: setup_autostart(False)),
        pystray.MenuItem('Вихід', lambda i, item: i.stop())
    )

    icon = pystray.Icon("LangSignal", create_image(), "LangSignal", menu=menu)
    icon.run()
