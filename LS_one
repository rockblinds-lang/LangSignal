import ctypes
import time
import threading
import winsound
import pystray
import os
import sys
from PIL import Image, ImageDraw
class LanguageHandler:
    def __init__(self):
        self.last_lang = self.get_current_lang()
        self.debounce_timer = None
        self.delay = 0.25 

    def get_current_lang(self):
        try:
            user32 = ctypes.windll.user32
            hwnd = user32.GetForegroundWindow()
            if not hwnd: return None
            thread_id = user32.GetWindowThreadProcessId(hwnd, 0)
            layout = user32.GetKeyboardLayout(thread_id) & 0xFFFF
            return layout
        except:
            return None

    def on_layout_change(self, new_lang):
        if new_lang is None or new_lang == self.last_lang:
            return
        if self.debounce_timer:
            self.debounce_timer.cancel()
        self.debounce_timer = threading.Timer(self.delay, self.confirm_change, [new_lang])
        self.debounce_timer.start()

    def confirm_change(self, confirmed_lang):
        current_now = self.get_current_lang()
        if confirmed_lang == current_now and confirmed_lang != self.last_lang:
            print(f"Зміна розкладки на: {confirmed_lang}")
            self.last_lang = confirmed_lang
            self.play_sound(confirmed_lang)

 def play_sound(self, lang):
        # Використовуємо прямий виклик системного динаміка
        try:
            if lang == 1033:  # EN
                winsound.Beep(600, 150) # Низький звук
            elif lang == 1058:  # UA
                winsound.Beep(1200, 150) # Високий звук
        except Exception as e:
            print(f"Звукова помилка: {e}")

def create_image(text="LS"):
    # Створюємо фон: Синій для UA, Сірий для EN
    bg_color = (0, 120, 215) if text == "UA" else (80, 80, 80)
    image = Image.new('RGB', (64, 64), color=bg_color)
    d = ImageDraw.Draw(image)
    
    # Спробуємо намалювати текст жирніше
    try:
        # Малюємо вручну жирні літери (якщо шрифт не підвантажився)
        d.text((12, 10), text, fill="white", stroke_width=2) 
    except:
        d.text((20, 20), text, fill="white")
        
    return image

def monitor_loop(handler, icon):
    print("LangSignal: Моніторинг активний...")
    while True:
        lang = handler.get_current_lang()
        if lang and lang != handler.last_lang:
            # Оновлюємо текст
            text = "EN" if lang == 1033 else "UA" if lang == 1058 else "!!"
            
            # 1. Змінюємо іконку
            icon.icon = create_image(text)
            
            # 2. Викликаємо обробку (там звук і фільтр)
            handler.on_layout_change(lang)
            
        time.sleep(0.3) # Трохи збільшили паузу для стабільності

    monitor_thread = threading.Thread(target=monitor_loop, args=(handler, icon), daemon=True)
    monitor_thread.start()

    # Створюємо меню
    menu = pystray.Menu(
        pystray.MenuItem('Автозапуск', lambda: setup_autostart(True)),
        pystray.MenuItem('Вимкнути автозапуск', lambda: setup_autostart(False)),
        pystray.MenuItem('Вихід', lambda i, item: i.stop())
    )

    icon = pystray.Icon("LangSignal", create_image(), "LangSignal", menu=menu)
    icon.run()
