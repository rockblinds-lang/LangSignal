import ctypes
import time
import threading
import winsound
import pystray
import os
import sys
from PIL import Image, ImageDraw, ImageFont

# 1. СЛОВНИК МОВ (універсальність)
LANG_MAP = {
    1033: "EN", # English (US)
    2057: "EN", # English (UK)
    1058: "UA", # Ukrainian
    1045: "PL", # Polish
    1031: "DE", # German
    1036: "FR", # French
}

class LanguageHandler:
    def __init__(self):
        self.last_lang = self.get_current_lang()

    def get_current_lang(self):
        try:
            user32 = ctypes.windll.user32
            hwnd = user32.GetForegroundWindow()
            if not hwnd: return None
            thread_id = user32.GetWindowThreadProcessId(hwnd, 0)
            layout = user32.GetKeyboardLayout(thread_id) & 0xFFFF
            return layout
        except:
            return None

    def play_sound(self, lang):
        try:
            # Стандартний звук Windows для підтвердження
            winsound.PlaySound("SystemAsterisk", winsound.SND_ALIAS | winsound.SND_ASYNC)
        except:
            pass

def create_image(text="LS"):
    # Кольорова палітра для комерційного вигляду
    colors = {
        "UA": (0, 120, 215),  # Синій
        "EN": (70, 70, 70),    # Темно-сірий
        "PL": (220, 20, 60),   # Червоний
        "DE": (0, 0, 0),       # Чорний
        "LS": (100, 100, 100)  # Сірий
    }
    bg_color = colors.get(text, (100, 100, 100))
    image = Image.new('RGB', (64, 64), color=bg_color)
    d = ImageDraw.Draw(image)
    
    try:
        # Використовуємо Arial Bold для чіткості
        font = ImageFont.truetype("arialbd.ttf", 40)
        d.text((5, 5), text, fill="white", font=font)
    except:
        d.text((15, 20), text, fill="white")
    return image

def monitor_loop(handler, icon):
    print("LangSignal: Моніторинг активний...")
    while True:
        lang = handler.get_current_lang()
        if lang and lang != handler.last_lang:
            text = LANG_MAP.get(lang, "??")
            print(f"Зміна мови на: {text} ({lang})")
            
            # Оновлення візуалу та звуку
            icon.icon = create_image(text)
            handler.last_lang = lang
            handler.play_sound(lang)
            
        time.sleep(0.2)

def setup_autostart(status):
    """Функція для меню автозапуску"""
    try:
        import pythoncom
        from win32com.client import Dispatch
        shortcut_path = os.path.join(os.getenv('APPDATA'), r'Microsoft\Windows\Start Menu\Programs\Startup', "LangSignal.lnk")
        if status:
            shell = Dispatch('WScript.Shell')
            shortcut = shell.CreateShortCut(shortcut_path)
            target = sys.executable if getattr(sys, 'frozen', False) else os.path.abspath(sys.argv)
            shortcut.Targetpath = target
            shortcut.WorkingDirectory = os.path.dirname(target)
            shortcut.save()
            print("Автозапуск активовано")
        else:
            if os.path.exists(shortcut_path): os.remove(shortcut_path)
    except Exception as e:
        print(f"Помилка автозапуску: {e}")

if __name__ == "__main__":
    handler = LanguageHandler()
    
    # Початковий стан іконки
    start_lang = handler.get_current_lang()
    start_text = LANG_MAP.get(start_lang, "LS")
    icon = pystray.Icon("LangSignal", create_image(start_text), "LangSignal")

    # Запуск моніторингу в окремому потоці
    monitor_thread = threading.Thread(target=monitor_loop, args=(handler, icon), daemon=True)
    monitor_thread.start()

    # Меню в треї
    icon.menu = pystray.Menu(
        pystray.MenuItem('Автозапуск увімкнути', lambda: setup_autostart(True)),
        pystray.MenuItem('Автозапуск вимкнути', lambda: setup_autostart(False)),
        pystray.MenuItem('Вихід', lambda i, item: i.stop())
    )

    icon.run()
